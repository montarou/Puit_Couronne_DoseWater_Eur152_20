# Puits Couronne - Modifications pour Dose en nGy et Absorption par Raie

## Résumé des modifications

Ce document décrit les modifications apportées au projet pour :
1. **Convertir les doses en nanoGray (nGy)** dans les histogrammes et ntuples
2. **Suivre l'absorption par raie gamma Eu-152** dans le filtre W/PETG et dans l'eau

---

## 1. Conversion des doses en nanoGray

### Formule de conversion

```
Dose (nGy) = E(MeV) × 0.160218 / m(g)
```

Où :
- E est l'énergie déposée en MeV
- m est la masse du volume en grammes
- Le facteur 0.160218 provient de : 1 MeV = 1.60218×10⁻¹³ J, puis conversion en nGy

### Implémentation

La classe `RunAction` fournit deux méthodes de conversion :

```cpp
// Conversion directe MeV → nGy pour une masse en g
static G4double EnergyToNanoGray(G4double energy_MeV, G4double mass_g);

// Conversion depuis les unités Geant4
static G4double ConvertToNanoGray(G4double energy, G4double mass);
```

### Données de sortie

#### Histogrammes (fichier ROOT)
- `h_dose_ring0` à `h_dose_ring4` : Dose par désintégration dans chaque anneau [nGy]
- `h_dose_total` : Dose totale par désintégration [nGy]
- `h_edep_line0` à `h_edep_line10` : Énergie déposée par raie gamma [keV]

#### Ntuple "doses"
| Colonne | Description |
|---------|-------------|
| `dose_nGy_ring0` à `dose_nGy_ring4` | Dose par anneau [nGy] |
| `dose_nGy_total` | Dose totale [nGy] |
| `edep_keV_total` | Énergie déposée totale [keV] |
| `nPrimaries` | Nombre de gammas primaires |
| `nTransmitted` | Nombre transmis |
| `nAbsorbed` | Nombre absorbés |

---

## 2. Suivi de l'absorption par raie gamma Eu-152

### Raies gamma suivies

| Index | Énergie (keV) | Intensité (%) |
|-------|---------------|---------------|
| 0 | 121.78 | 28.41 |
| 1 | 244.70 | 7.53 |
| 2 | 344.28 | 26.59 |
| 3 | 411.12 | 2.24 |
| 4 | 443.97 | 2.83 |
| 5 | 778.90 | 12.97 |
| 6 | 867.38 | 4.24 |
| 7 | 964.08 | 14.63 |
| 8 | 1085.87 | 10.21 |
| 9 | 1112.07 | 13.64 |
| 10 | 1408.01 | 21.01 |

### Métriques calculées

Pour chaque raie gamma :
- **Émis** : Nombre de gammas de cette raie générés
- **Sortis filtre** : Nombre ayant traversé le filtre W/PETG
- **Absorbés filtre** : Nombre absorbés dans le filtre
- **Entrés eau** : Nombre entrés dans l'eau
- **Absorbés eau** : Nombre absorbés dans l'eau

### Taux d'absorption

```
Taux absorption filtre (%) = 100 × (Absorbés filtre) / (Émis)
Taux absorption eau (%)    = 100 × (Absorbés eau) / (Entrés eau)
```

### Ntuple "gamma_lines"
| Colonne | Description |
|---------|-------------|
| `lineIndex` | Index de la raie (0-10) |
| `energy_keV` | Énergie de la raie [keV] |
| `emitted` | Nombre émis |
| `exitedFilter` | Nombre sortis du filtre |
| `absorbedFilter` | Nombre absorbés dans le filtre |
| `enteredWater` | Nombre entrés dans l'eau |
| `absorbedWater` | Nombre absorbés dans l'eau |
| `filterAbsRate` | Taux d'absorption filtre [%] |
| `waterAbsRate` | Taux d'absorption eau [%] |

---

## 3. Affichage en fin de run

### Tableau des doses par anneau (nGy)

```
╔══════════╦═══════════════╦═══════════════╦═══════════════╦═══════════════╦════════════════════╗
║  Anneau  ║   Masse (g)   ║ E_dep (MeV)   ║  Dose (nGy)   ║ Dose/evt(nGy) ║  Événements        ║
╠══════════╬═══════════════╬═══════════════╬═══════════════╬═══════════════╬════════════════════╣
║    0     ║       ...     ║     ...       ║      ...      ║      ...      ║       ...          ║
...
```

### Tableau d'absorption par raie

```
╔═══════════════╦═══════════╦═══════════════╦═══════════════╦═══════════════╦═══════════════╦═══════════════════════════╗
║     Raie      ║   Émis    ║ Sortis filtre ║  Abs. filtre  ║ Entrés eau    ║   Abs. eau    ║  Taux abs. filtre/eau (%) ║
╠═══════════════╬═══════════╬═══════════════╬═══════════════╬═══════════════╬═══════════════╬═══════════════════════════╣
║ 122 keV       ║     ...   ║      ...      ║      ...      ║      ...      ║      ...      ║    XX.XX /    YY.YY       ║
...
```

---

## 4. Fichiers modifiés

| Fichier | Modifications |
|---------|---------------|
| `EventAction.hh/.cc` | Ajout du suivi par raie gamma, identification des raies |
| `RunAction.hh/.cc` | Conversion nGy, statistiques par raie, tableaux de sortie |
| `SteppingAction.cc` | Suivi des passages et absorptions par raie |
| `PrimaryGeneratorAction.cc` | Spectre Eu-152 avec identification des raies |

---

## 5. Utilisation

### Compilation

```bash
mkdir build && cd build
cmake ..
make -j4
```

### Exécution

```bash
./puits_couronne run.mac
```

### Analyse ROOT

```cpp
// Ouvrir le fichier
TFile* f = TFile::Open("puits_couronne.root");

// Accéder au ntuple des doses
TTree* doses = (TTree*)f->Get("doses");
doses->Draw("dose_nGy_total");

// Accéder au ntuple des raies gamma
TTree* lines = (TTree*)f->Get("gamma_lines");
lines->Draw("filterAbsRate:energy_keV");
```

---

## 6. Notes importantes

1. **Identification des raies** : Une tolérance de 0.5 keV est utilisée pour identifier les raies gamma.

2. **Suivi des secondaires** : L'énergie déposée par les électrons secondaires est attribuée au gamma primaire parent quand c'est possible.

3. **Absorption** : Un gamma est considéré comme "absorbé" quand sa trace est tuée (fStopAndKill) dans le volume concerné.

4. **Validation** : Les compteurs de vérification (pre/post filtre, pre/post eau) permettent de valider les taux d'absorption.
